{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block head_extra %}
<style>
    .matrix-container {
        overflow-x: auto;
    }
    .matrix-table {
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.85rem;
    }
    .matrix-table th,
    .matrix-table td {
        border: 1px solid #dee2e6;
        padding: 0.25rem 0.4rem;
        text-align: center;
        vertical-align: middle;
    }
    .matrix-table thead th {
        background-color: #f8f9fa;
        position: sticky;
        top: 0;
        z-index: 10;
    }
    .matrix-table thead th.modality-header {
        writing-mode: vertical-rl;
        text-orientation: mixed;
        transform: rotate(180deg);
        height: 120px;
        white-space: nowrap;
        font-size: 0.75rem;
        padding: 0.3rem;
    }
    .matrix-table tbody th.challenge-cell {
        text-align: left;
        background-color: #f8f9fa;
        position: sticky;
        left: 0;
        z-index: 5;
        width: 140px;
        min-width: 140px;
        max-width: 140px;
        padding: 0.3rem 0.4rem;
    }
    .challenge-name {
        font-weight: 500;
        font-size: 0.8rem;
        line-height: 1.2;
        word-wrap: break-word;
        overflow-wrap: break-word;
        hyphens: auto;
    }
    .value-step-badge {
        font-size: 0.6rem;
        display: inline-block;
        padding: 0.1rem 0.3rem;
        margin-top: 2px;
        line-height: 1;
        border-radius: 0.2rem;
    }
    /* Cell styles - compact */
    .matrix-cell {
        width: 32px;
        min-width: 32px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    /* Base color classes (for legend) */
    .cell-applicable { background-color: #d4edda; }
    .cell-not-applicable { background-color: #f8f9fa; }
    /* Innovation Need: Kritisch (hoch) → Minimal (niedrig) */
    .cell-innovation-critical { background-color: #c0392b; }
    .cell-innovation-high { background-color: #e67e22; }
    .cell-innovation-medium { background-color: #f39c12; }
    .cell-innovation-low { background-color: #d4edda; }
    .cell-innovation-minimal { background-color: #27ae60; }
    .matrix-table td.cell-innovation-critical { background-color: #c0392b !important; color: white; }
    .matrix-table td.cell-innovation-high { background-color: #e67e22 !important; color: white; }
    .matrix-table td.cell-innovation-medium { background-color: #f39c12 !important; color: #856404; }
    .matrix-table td.cell-innovation-low { background-color: #d4edda !important; color: #155724; }
    .matrix-table td.cell-innovation-minimal { background-color: #27ae60 !important; color: white; }
    .cell-impact-1 { background-color: #d4edda; }
    .cell-impact-2 { background-color: #a8d5a2; }
    .cell-impact-3 { background-color: #ffeaa7; }
    .cell-impact-4 { background-color: #fdcb6e; }
    .cell-impact-5 { background-color: #e17055; }
    /* Maturity: 1=low (red) → 9=high (green) */
    .cell-maturity-1 { background-color: #c0392b; }
    .cell-maturity-2 { background-color: #e17055; }
    .cell-maturity-3 { background-color: #e67e22; }
    .cell-maturity-4 { background-color: #fdcb6e; }
    .cell-maturity-5 { background-color: #ffeaa7; }
    .cell-maturity-6 { background-color: #d4edda; }
    .cell-maturity-7 { background-color: #a8d5a2; }
    .cell-maturity-8 { background-color: #7dcea0; }
    .cell-maturity-9 { background-color: #27ae60; }
    /* Override Bootstrap table td background - use !important for specificity */
    .matrix-table td.cell-applicable { background-color: #d4edda !important; color: #155724; }
    .matrix-table td.cell-not-applicable { background-color: #f8f9fa !important; color: #ccc; }
    /* Impact: 1=low impact (green) → 5=high impact (red) */
    .matrix-table td.cell-impact-1 { background-color: #d4edda !important; color: #155724; }
    .matrix-table td.cell-impact-2 { background-color: #a8d5a2 !important; color: #155724; }
    .matrix-table td.cell-impact-3 { background-color: #ffeaa7 !important; color: #856404; }
    .matrix-table td.cell-impact-4 { background-color: #fdcb6e !important; color: #856404; }
    .matrix-table td.cell-impact-5 { background-color: #e17055 !important; color: white; }
    /* Maturity: 1=low maturity (red) → 9=high maturity (green) */
    .matrix-table td.cell-maturity-1 { background-color: #c0392b !important; color: white; }
    .matrix-table td.cell-maturity-2 { background-color: #e17055 !important; color: white; }
    .matrix-table td.cell-maturity-3 { background-color: #e67e22 !important; color: white; }
    .matrix-table td.cell-maturity-4 { background-color: #fdcb6e !important; color: #856404; }
    .matrix-table td.cell-maturity-5 { background-color: #ffeaa7 !important; color: #856404; }
    .matrix-table td.cell-maturity-6 { background-color: #d4edda !important; color: #155724; }
    .matrix-table td.cell-maturity-7 { background-color: #a8d5a2 !important; color: #155724; }
    .matrix-table td.cell-maturity-8 { background-color: #7dcea0 !important; color: #155724; }
    .matrix-table td.cell-maturity-9 { background-color: #27ae60 !important; color: white; }
    .filter-controls {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    .display-mode-btn.active {
        font-weight: bold;
    }
    .display-mode-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }
    .cell-tooltip {
        cursor: help;
    }
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 0.75rem;
        font-size: 0.8rem;
    }
    .legend-color {
        width: 16px;
        height: 16px;
        border-radius: 2px;
        margin-right: 4px;
        border: 1px solid #ddd;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1><i class="fas fa-th text-primary me-2"></i>Challenge-Modality Matrix</h1>
            <p class="text-muted">
                Matrix view of manufacturing challenges across modalities. Filter by value step and select display mode.
            </p>
        </div>
        <div>
            <button class="btn btn-outline-secondary btn-sm" onclick="window.print()">
                <i class="fas fa-print"></i> Print
            </button>
        </div>
    </div>

    <!-- Filter and Display Controls -->
    <div class="filter-controls">
        <div class="row align-items-center">
            <div class="col-md-4">
                <label class="form-label fw-bold mb-1" for="valueStepFilter">Filter by Value Step</label>
                <select id="valueStepFilter" class="form-select form-select-sm" title="Filter challenges by value step">
                    <option value="">All Value Steps</option>
                    {% for vs in value_steps %}
                    <option value="{{ vs.name }}">{{ vs.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold mb-1">Display Mode</label>
                <div class="btn-group btn-group-sm" role="group">
                    <button type="button" class="btn btn-outline-primary display-mode-btn active" data-mode="innovation">
                        <i class="fas fa-lightbulb"></i> Innovationsbedarf
                    </button>
                    <button type="button" class="btn btn-outline-primary display-mode-btn" data-mode="impact">
                        <i class="fas fa-bolt"></i> Impact
                    </button>
                    <button type="button" class="btn btn-outline-primary display-mode-btn" data-mode="maturity">
                        <i class="fas fa-chart-line"></i> Maturity
                    </button>
                </div>
            </div>
            <div class="col-md-4">
                <label class="form-label fw-bold mb-1" for="sortOrder">Sort Challenges</label>
                <select id="sortOrder" class="form-select form-select-sm" title="Sort challenges by criteria">
                    <option value="name">By Name (A-Z)</option>
                    <option value="value_step" selected>By Value Step</option>
                    <option value="applicability">By Applicability Count</option>
                </select>
            </div>
        </div>
        <!-- Legend -->
        <div class="mt-3" id="legend-container">
            <div id="legend-innovation" class="legend">
                <span class="legend-item"><span class="legend-color cell-innovation-critical"></span> Kritisch (30+)</span>
                <span class="legend-item"><span class="legend-color cell-innovation-high"></span> Hoch (20-29)</span>
                <span class="legend-item"><span class="legend-color cell-innovation-medium"></span> Mittel (10-19)</span>
                <span class="legend-item"><span class="legend-color cell-innovation-low"></span> Niedrig (5-9)</span>
                <span class="legend-item"><span class="legend-color cell-innovation-minimal"></span> Minimal (1-4)</span>
                <span class="legend-item"><span class="legend-color cell-not-applicable"></span> N/A</span>
            </div>
            <div id="legend-impact" class="legend d-none">
                <span class="legend-item"><span class="legend-color cell-impact-1"></span> 1 (Low)</span>
                <span class="legend-item"><span class="legend-color cell-impact-2"></span> 2</span>
                <span class="legend-item"><span class="legend-color cell-impact-3"></span> 3</span>
                <span class="legend-item"><span class="legend-color cell-impact-4"></span> 4</span>
                <span class="legend-item"><span class="legend-color cell-impact-5"></span> 5 (High)</span>
            </div>
            <div id="legend-maturity" class="legend d-none">
                <span class="legend-item"><span class="legend-color cell-maturity-1"></span> 1 (Low)</span>
                <span class="legend-item"><span class="legend-color cell-maturity-2"></span> 2</span>
                <span class="legend-item"><span class="legend-color cell-maturity-3"></span> 3</span>
                <span class="legend-item"><span class="legend-color cell-maturity-4"></span> 4</span>
                <span class="legend-item"><span class="legend-color cell-maturity-5"></span> 5</span>
                <span class="legend-item"><span class="legend-color cell-maturity-6"></span> 6</span>
                <span class="legend-item"><span class="legend-color cell-maturity-7"></span> 7</span>
                <span class="legend-item"><span class="legend-color cell-maturity-8"></span> 8</span>
                <span class="legend-item"><span class="legend-color cell-maturity-9"></span> 9 (High)</span>
            </div>
        </div>
    </div>

    <!-- Matrix Card -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <div class="row align-items-center">
                <div class="col">
                    <h5 class="mb-0">Challenges vs. Modalities</h5>
                </div>
                <div class="col-auto">
                    <span class="badge bg-primary" id="challengeCount">{{ challenges|length }} Challenges</span>
                    <span class="badge bg-secondary">{{ modalities|length }} Modalities</span>
                </div>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="matrix-container">
                <table class="table matrix-table mb-0" id="matrixTable">
                    <thead>
                        <tr>
                            <th class="challenge-cell">Challenge</th>
                            {% for mod in modalities %}
                            <th class="modality-header" title="{{ mod.short_description or mod.name }}">
                                {{ mod.label or mod.name }}
                            </th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody id="matrixBody">
                        {% for challenge in challenges %}
                        <tr data-challenge-id="{{ challenge.id }}" data-value-step="{{ challenge.value_step or '' }}">
                            <th class="challenge-cell" title="{{ challenge.agnostic_description or '' }}">
                                <div class="challenge-name">{{ challenge.name }}</div>
                                {% if challenge.value_step %}
                                <span class="badge value-step-badge
                                    {% if challenge.value_step == 'Upstream' %}bg-info text-dark
                                    {% elif challenge.value_step == 'Downstream' %}bg-success
                                    {% elif challenge.value_step == 'Conjugation' %}bg-warning text-dark
                                    {% elif challenge.value_step == 'Fill & Finish' %}bg-primary
                                    {% elif challenge.value_step == 'Assembly' %}bg-dark
                                    {% elif challenge.value_step == 'QC/Reg' %}bg-danger
                                    {% else %}bg-secondary{% endif %}">
                                    {{ challenge.value_step }}
                                </span>
                                {% endif %}
                            </th>
                            {% for mod in modalities %}
                            {% set detail = matrix.get(challenge.id, {}).get(mod.id, {}) %}
                            <td class="matrix-cell cell-tooltip
                                {% if detail.get('applicable') %}cell-applicable{% else %}cell-not-applicable{% endif %}"
                                data-challenge-id="{{ challenge.id }}"
                                data-modality-id="{{ mod.id }}"
                                data-modality-name="{{ mod.name }}"
                                data-applicable="{{ 'true' if detail.get('applicable') else 'false' }}"
                                data-impact="{{ detail.get('impact_score', '') }}"
                                data-maturity="{{ detail.get('maturity_score', '') }}"
                                data-impact-details="{{ detail.get('impact_details', '') | e }}"
                                data-maturity-details="{{ detail.get('maturity_details', '') | e }}"
                                title="{% if detail.get('applicable') %}{{ mod.name }}: Impact={{ detail.get('impact_score', 'N/A') }}, Maturity={{ detail.get('maturity_score', 'N/A') }}{% else %}Not applicable{% endif %}">
                                {% if detail.get('applicable') %}
                                    {% set inn_score = (detail.get('impact_score', 0)|int) * (10 - (detail.get('maturity_score', 5)|int)) %}
                                    <span class="cell-value-innovation">{{ inn_score if detail.get('impact_score') and detail.get('maturity_score') else '–' }}</span>
                                    <span class="cell-value-impact d-none">{{ detail.get('impact_score', '–') }}</span>
                                    <span class="cell-value-maturity d-none">{{ detail.get('maturity_score', '–') }}</span>
                                {% else %}
                                    <span class="cell-value-innovation">–</span>
                                    <span class="cell-value-impact d-none">–</span>
                                    <span class="cell-value-maturity d-none">–</span>
                                {% endif %}
                            </td>
                            {% endfor %}
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="{{ modalities|length + 1 }}" class="text-center py-5">
                                <div class="text-muted">
                                    <i class="fas fa-database fa-3x mb-3"></i>
                                    <p>No challenges found. Import challenge data first.</p>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const valueStepFilter = document.getElementById('valueStepFilter');
    const sortOrder = document.getElementById('sortOrder');
    const displayModeButtons = document.querySelectorAll('.display-mode-btn');
    const matrixBody = document.getElementById('matrixBody');

    // Value chain order from database (passed from backend)
    const VALUE_STEPS = {{ value_steps | tojson }};
    const VALUE_STEP_ORDER = VALUE_STEPS.map(vs => vs.name);

    function getValueStepSortIndex(valueStep) {
        const step = VALUE_STEPS.find(vs => vs.name === valueStep);
        return step ? step.sort_order : 999;
    }

    let currentDisplayMode = 'innovation';

    // Display mode switching
    displayModeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            displayModeButtons.forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            currentDisplayMode = this.dataset.mode;
            updateDisplayMode();
            updateLegend();
        });
    });

    function getInnovationClass(score) {
        if (score >= 30) return 'cell-innovation-critical';
        if (score >= 20) return 'cell-innovation-high';
        if (score >= 10) return 'cell-innovation-medium';
        if (score >= 5) return 'cell-innovation-low';
        return 'cell-innovation-minimal';
    }

    function getInnovationLabel(score) {
        if (score >= 30) return 'Kritisch';
        if (score >= 20) return 'Hoch';
        if (score >= 10) return 'Mittel';
        if (score >= 5) return 'Niedrig';
        return 'Minimal';
    }

    function updateDisplayMode() {
        const cells = document.querySelectorAll('.matrix-cell');
        cells.forEach(cell => {
            const applicable = cell.dataset.applicable === 'true';
            const impact = parseInt(cell.dataset.impact) || 0;
            const maturity = parseInt(cell.dataset.maturity) || 0;
            const modalityName = cell.dataset.modalityName || '';
            const impactDetails = cell.dataset.impactDetails || '';
            const maturityDetails = cell.dataset.maturityDetails || '';

            // Hide all value spans
            cell.querySelectorAll('[class^="cell-value-"]').forEach(span => {
                span.classList.add('d-none');
            });

            // Remove all cell styling classes
            cell.classList.remove('cell-applicable', 'cell-not-applicable');
            cell.classList.remove('cell-innovation-critical', 'cell-innovation-high', 'cell-innovation-medium', 'cell-innovation-low', 'cell-innovation-minimal');
            for (let i = 1; i <= 9; i++) {
                cell.classList.remove('cell-impact-' + i, 'cell-maturity-' + i);
            }

            // Calculate innovation score
            const innovationScore = impact * (10 - maturity);

            // Update tooltip based on display mode
            let tooltipText = 'Not applicable';
            if (applicable) {
                if (currentDisplayMode === 'innovation') {
                    const label = getInnovationLabel(innovationScore);
                    tooltipText = `${modalityName}: Innovationsbedarf=${innovationScore} (${label})\nImpact=${impact}, Maturity=${maturity}`;
                } else if (currentDisplayMode === 'impact') {
                    tooltipText = impactDetails || `${modalityName}: Impact=${impact || 'N/A'}`;
                } else if (currentDisplayMode === 'maturity') {
                    tooltipText = maturityDetails || `${modalityName}: Maturity=${maturity || 'N/A'}`;
                }
            }

            // Update native title attribute for tooltip
            cell.setAttribute('title', tooltipText);

            if (currentDisplayMode === 'innovation') {
                cell.querySelector('.cell-value-innovation').classList.remove('d-none');
                if (applicable && impact && maturity) {
                    cell.classList.add(getInnovationClass(innovationScore));
                } else {
                    cell.classList.add('cell-not-applicable');
                }
            } else if (currentDisplayMode === 'impact') {
                cell.querySelector('.cell-value-impact').classList.remove('d-none');
                if (applicable && impact) {
                    cell.classList.add('cell-impact-' + impact);
                } else {
                    cell.classList.add('cell-not-applicable');
                }
            } else if (currentDisplayMode === 'maturity') {
                cell.querySelector('.cell-value-maturity').classList.remove('d-none');
                if (applicable && maturity) {
                    cell.classList.add('cell-maturity-' + maturity);
                } else {
                    cell.classList.add('cell-not-applicable');
                }
            }
        });
    }

    function updateLegend() {
        document.querySelectorAll('.legend').forEach(l => l.classList.add('d-none'));
        document.getElementById('legend-' + currentDisplayMode).classList.remove('d-none');
    }

    // Filter by value step
    valueStepFilter.addEventListener('change', function() {
        filterAndSort();
    });

    // Sort order change
    sortOrder.addEventListener('change', function() {
        filterAndSort();
    });

    function filterAndSort() {
        const filterValue = valueStepFilter.value;
        const sortValue = sortOrder.value;
        const rows = Array.from(matrixBody.querySelectorAll('tr[data-challenge-id]'));

        // Filter
        rows.forEach(row => {
            const valueStep = row.dataset.valueStep || '';
            if (!filterValue || valueStep === filterValue) {
                row.style.display = '';
            } else {
                row.style.display = 'none';
            }
        });

        // Sort visible rows
        const visibleRows = rows.filter(r => r.style.display !== 'none');
        visibleRows.sort((a, b) => {
            if (sortValue === 'name') {
                const nameA = a.querySelector('.challenge-name').textContent.toLowerCase();
                const nameB = b.querySelector('.challenge-name').textContent.toLowerCase();
                return nameA.localeCompare(nameB);
            } else if (sortValue === 'value_step') {
                const idxA = getValueStepSortIndex(a.dataset.valueStep);
                const idxB = getValueStepSortIndex(b.dataset.valueStep);
                return idxA - idxB;
            } else if (sortValue === 'applicability') {
                const countA = a.querySelectorAll('.matrix-cell[data-applicable="true"]').length;
                const countB = b.querySelectorAll('.matrix-cell[data-applicable="true"]').length;
                return countB - countA; // Descending
            }
            return 0;
        });

        // Re-append sorted rows
        visibleRows.forEach(row => matrixBody.appendChild(row));

        // Update count
        const visibleCount = visibleRows.length;
        document.getElementById('challengeCount').textContent = visibleCount + ' Challenges';
    }

    // Initialize display mode on page load
    updateDisplayMode();

});
</script>
{% endblock %}
