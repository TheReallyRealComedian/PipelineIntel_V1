{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="product-detail-page">
    <!-- Breadcrumb and Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">
                        <a href="{{ url_for('products.list_products') }}">Products</a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">{{ product.product_code }}</li>
                </ol>
            </nav>
            <h1>{{ product.product_name or product.product_code }}</h1>
            {% if product.modality %}
            <p class="text-color-light">
                <i class="fas fa-tag"></i> {{ product.modality.modality_name }}
                {% if product.modality.modality_category %}
                <span class="badge bg-secondary ms-2">{{ product.modality.modality_category }}</span>
                {% endif %}
                {% if product.current_phase %}
                <span class="badge bg-primary ms-2">{{ product.current_phase }}</span>
                {% endif %}
            </p>
            {% endif %}
        </div>
        <div>
            <a href="{{ url_for('products.list_products') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left"></i> Back to Products
            </a>
        </div>
    </div>

    <!-- Product Overview -->
    <div class="row mb-4">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title mb-0">
                        <i class="fas fa-info-circle text-primary"></i>
                        Product Information
                    </h2>
                </div>
                <div class="card-body">
                    <table class="table table-sm">
                        <tbody>
                            <tr>
                                <th scope="row" style="width: 30%;">Product Code</th>
                                <td><strong>{{ product.product_code }}</strong></td>
                            </tr>
                            <tr>
                                <th scope="row">Product Name</th>
                                <td>{{ product.product_name or '-' }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Product Type</th>
                                <td>{{ product.product_type or '-' }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Therapeutic Area</th>
                                <td>{{ product.therapeutic_area or '-' }}</td>
                            </tr>
                            <tr>
                                <th scope="row">Current Phase</th>
                                <td>
                                    {% if product.current_phase %}
                                    <span class="badge bg-primary">{{ product.current_phase }}</span>
                                    {% else %}
                                    -
                                    {% endif %}
                                </td>
                            </tr>
                            {% if product.mechanism_of_action %}
                            <tr>
                                <th scope="row">Mechanism of Action</th>
                                <td>{{ product.mechanism_of_action }}</td>
                            </tr>
                            {% endif %}
                            {% if product.dosage_form %}
                            <tr>
                                <th scope="row">Dosage Form</th>
                                <td>{{ product.dosage_form }}</td>
                            </tr>
                            {% endif %}
                            {% if product.expected_launch_year %}
                            <tr>
                                <th scope="row">Expected Launch</th>
                                <td>{{ product.expected_launch_year }}</td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                    
                    {% if product.short_description %}
                    <div class="mt-3">
                        <h6>Description</h6>
                        <p class="text-muted">{{ product.short_description }}</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-chart-line text-success"></i>
                        Key Metrics
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-12 mb-3">
                            <div class="text-center">
                                <div class="h4 text-primary">{{ product.indications|length }}</div>
                                <div class="small text-muted">Clinical Indications</div>
                            </div>
                        </div>
                        <div class="col-12 mb-3">
                            <div class="text-center">
                                <div class="h4 text-warning" id="challenge-count">-</div>
                                <div class="small text-muted">Active Challenges</div>
                            </div>
                        </div>
                        <div class="col-12">
                            <div class="text-center">
                                <div class="h4 text-info">{{ product.technologies|length }}</div>
                                <div class="small text-muted">Technologies</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Clinical Indications -->
    {% if product.indications %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-stethoscope text-info"></i>
                        Clinical Indications
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Indication</th>
                                    <th>Therapeutic Area</th>
                                    <th>Phase</th>
                                    <th>Expected Launch</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for indication in product.indications %}
                                <tr>
                                    <td><strong>{{ indication.indication_name }}</strong></td>
                                    <td>{{ indication.therapeutic_area or '-' }}</td>
                                    <td>
                                        {% if indication.development_phase %}
                                        <span class="badge bg-secondary">{{ indication.development_phase }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ indication.expected_launch_year or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Manufacturing Challenges Section -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-exclamation-triangle text-warning"></i>
                        Manufacturing Challenges
                    </h3>
                    <div class="card-tools">
                        <button type="button" class="btn btn-sm btn-primary" id="add-challenge-btn">
                            <i class="fas fa-plus"></i> Add Challenge
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <div class="challenge-management-container">
                        <!-- Challenge sections will be loaded here via JavaScript -->
                        <div id="challenges-loading" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted"></i>
                            <p class="mt-2 text-muted">Loading challenge inheritance system...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Manufacturing Technologies -->
    {% if product.technologies %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-cogs text-secondary"></i>
                        Manufacturing Technologies
                    </h3>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for technology in product.technologies %}
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3 h-100">
                                <h6 class="mb-2">{{ technology.technology_name }}</h6>
                                {% if technology.short_description %}
                                <p class="text-muted small mb-0">{{ technology.short_description }}</p>
                                {% endif %}
                                {% if technology.stage %}
                                <div class="mt-2">
                                    <span class="badge bg-light text-dark">{{ technology.stage.stage_name }}</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Supply Chain -->
    {% if product.supply_chain %}
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title mb-0">
                        <i class="fas fa-truck text-primary"></i>
                        Supply Chain
                    </h3>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Manufacturing Stage</th>
                                    <th>Supply Model</th>
                                    <th>Manufacturing Entity</th>
                                    <th>Internal Site</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for supply_link in product.supply_chain %}
                                <tr>
                                    <td><strong>{{ supply_link.manufacturing_stage }}</strong></td>
                                    <td>{{ supply_link.supply_model or '-' }}</td>
                                    <td>
                                        {% if supply_link.manufacturing_entity %}
                                        {{ supply_link.manufacturing_entity.entity_name }}
                                        <span class="badge bg-secondary ms-1">{{ supply_link.manufacturing_entity.entity_type }}</span>
                                        {% else %}
                                        -
                                        {% endif %}
                                    </td>
                                    <td>{{ supply_link.internal_site_name or '-' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Challenge Modal for Adding New Challenges -->
<div class="modal fade" id="add-challenge-modal" tabindex="-1" aria-labelledby="addChallengeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addChallengeModalLabel">
                    <i class="fas fa-plus-circle text-primary"></i>
                    Add Product-Specific Challenge
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="challenge-select" class="form-label">
                        <strong>Select Challenge</strong>
                        <small class="text-muted">(Only challenges not already associated with this product are shown)</small>
                    </label>
                    <select class="form-select" id="challenge-select" required>
                        <option value="">Choose a challenge...</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label for="challenge-notes" class="form-label">
                        <strong>Notes</strong>
                        <small class="text-muted">(Optional)</small>
                    </label>
                    <textarea class="form-control" id="challenge-notes" rows="3" 
                        placeholder="Why is this challenge relevant to this specific product? Any additional context..."></textarea>
                    <div class="form-text">
                        These notes help explain why this challenge applies specifically to this product, 
                        beyond what's covered by the modality template.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="btn btn-primary" id="confirm-add-challenge">
                    <i class="fas fa-plus"></i> Add Challenge
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{# CHANGE #}
{% block head_extra %}
{{ super() }}
{# CSS was previously in a non-existent block 'extra_css' #}
<style>
/* Challenge Management Styles */
.challenge-sections {
    margin-top: 1rem;
}

.challenge-section {
    border: 1px solid #e0e0e0;
    border-radius: 8px;
    padding: 1rem;
    background-color: #fafafa;
    margin-bottom: 1.5rem;
}

.section-title {
    color: #333;
    margin-bottom: 1rem;
    font-weight: 600;
    display: flex;
    align-items: center;
}

.section-title i {
    margin-right: 0.5rem;
}

.challenge-item {
    background: white;
    border: 1px solid #ddd;
    border-radius: 6px;
    margin-bottom: 0.75rem;
    transition: all 0.2s ease;
}

.challenge-item:hover {
    border-color: #007bff;
    box-shadow: 0 2px 4px rgba(0,123,255,0.1);
}

.challenge-item.excluded {
    background-color: #f8f9fa;
    opacity: 0.7;
    border-color: #dc3545;
    border-left: 4px solid #dc3545;
}

.challenge-item.excluded .challenge-name {
    text-decoration: line-through;
    color: #6c757d;
}

.challenge-item.explicit {
    border-left: 4px solid #28a745;
    background-color: #f8fff9;
}

.challenge-content {
    padding: 1rem;
}

.challenge-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 0.5rem;
}

.challenge-info {
    flex: 1;
}

.challenge-controls {
    margin-left: 1rem;
    flex-shrink: 0;
}

.challenge-name {
    color: #333;
    font-size: 1rem;
}

.challenge-description {
    font-size: 0.9rem;
    line-height: 1.4;
    margin-top: 0.5rem;
}

.challenge-notes {
    background-color: #f8f9fa;
    padding: 0.75rem;
    border-radius: 4px;
    border-left: 3px solid #6c757d;
    margin-top: 0.75rem;
}

.challenge-summary {
    margin-top: 1rem;
}

.form-check-label {
    font-size: 0.9rem;
}

.badge {
    font-size: 0.75rem;
}

/* Loading state */
#challenges-loading {
    color: #6c757d;
}

/* Modal improvements */
.modal-header .modal-title {
    display: flex;
    align-items: center;
}

.modal-header .modal-title i {
    margin-right: 0.5rem;
}

#challenge-select optgroup {
    font-weight: bold;
    color: #495057;
}

#challenge-select option {
    font-weight: normal;
    padding: 0.25rem 0.5rem;
}

/* Product detail specific styles */
.product-detail-page .card-title {
    display: flex;
    align-items: center;
}

.product-detail-page .card-title i {
    margin-right: 0.5rem;
}

/* Responsive design */
@media (max-width: 768px) {
    .challenge-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .challenge-controls {
        margin-left: 0;
        margin-top: 0.5rem;
    }
    
    .card-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .card-tools {
        margin-top: 0.5rem;
    }
}
</style>
{% endblock %}

{# CHANGE #}
{% block scripts %}
{{ super() }}
{# JS was previously in a non-existent block 'extra_js' #}
<script>
// Set the product ID for the JavaScript to use
window.PRODUCT_ID = {{ product.product_id }};

// Update challenge count in sidebar when challenges load
document.addEventListener('challengesLoaded', function(event) {
    const challengeCount = document.getElementById('challenge-count');
    if (challengeCount && event.detail.effectiveCount !== undefined) {
        challengeCount.textContent = event.detail.effectiveCount;
    }
});
</script>
<script src="{{ url_for('static', filename='js/challenge_management.js') }}"></script>
{% endblock %}